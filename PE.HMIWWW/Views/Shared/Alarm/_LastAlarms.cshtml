<div style="position:absolute; right:0px; top:0px;">
    @Html.ImageButton("alarms", "Url('alarms', 'index')")
    @*@Html.ImageButton("new", "StartSignalR()", false)*@
</div>

<table id="alarm-table">
    <thead>
        <tr>
            <th style="width: 50px;">@VM_Resources.NAME_AlarmCategoryName</th>
            <th style="width: 60px;">@VM_Resources.NAME_AlarmType</th>
            <th style="width: 120px;">@VM_Resources.NAME_AlarmOwner</th>
            <th style="width: 200px;">@VM_Resources.NAME_AlarmDate</th>
            <th style="width: 700px;">@VM_Resources.NAME_Message</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

<style>
  /* Debug(0), Info(1), Warning(2), Error(3) */
    #alarm-table tr:nth-child(even) {
        background: #f5f5f5;
        color: #63666a;
    }

    #alarm-table tr:nth-child(odd) {
        background: #ffffff;
        color: #63666a;
    }

    #alarm-table tr.alarm-2:nth-child(even) {
        background: #ffcd00;
        color: #425563;
    }

    #alarm-table tr.alarm-2:nth-child(odd) {
        background: #ffcd00;
        color: #425563;
    }

    #alarm-table tr.alarm-3:nth-child(even) {
        background: #ce0037;
        color: #ffffff;
    }

    #alarm-table tr.alarm-3:nth-child(odd) {
        background: #ce0037;
        color: #ffffff;
    }
</style>

<script>
    $(document).ready(function () {
      InitAlarmTable();
      SignalrConnection.on("System2HmiBroadcastLastAlarms", (alarmData) => {
        if (!Array.isArray(alarmData.Roles) || !alarmData.Roles.length || userRoles.some(item => alarmData.Roles.includes(item)))
          BuildAlarmTable(alarmData);
        });
    });

    function BuildAlarmTable(data) {
      try {
        var table = document.getElementById("alarm-table").getElementsByTagName('tbody')[0];

        let row = table.insertRow(0);

        let cell0 = row.insertCell(0);
        let cell1 = row.insertCell(1);
        let cell2 = row.insertCell(2);
        let cell3 = row.insertCell(3);
        let cell4 = row.insertCell(4);

        cell0.innerHTML = data.AlarmCategoryName;
        cell1.innerHTML = data.AlarmTypeName;
        cell2.innerHTML = data.AlarmOwner;
        cell3.innerHTML = kendo.toString(new Date(data.AlarmDate), "HH:mm:ss MM.dd.yyyy");
        cell4.innerHTML = data.Message;

        row.classList.add("alarm-"+data.AlarmType);

        let rowCount = table.rows.length;
        let maxRows = 5;
        if (rowCount > maxRows)
          for (let i = maxRows; i < rowCount; i++)
            table.deleteRow(-1);
      }
      catch (ex) {
          trace(ex);
      }
    }

    function InitAlarmTable() {
      $.ajax(
        {
          type: "POST",
          page: 1,
          rp: 6,
          url: '@Url.Action("GetLastShortAlarmData", "Alarm", new { Area = "" })',
          dataType: "json",
          success: function (result) {
            for (var i = result.Data.length-1; i >= 0; i--) {
              BuildAlarmTable(result.Data[i]);
            }
          },
          error: function (x, e) {
          }
        });
    }
</script>
